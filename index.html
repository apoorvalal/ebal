<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Package implements entropy balancing, a data preprocessing procedure described in Hainmueller (2012, &lt;doi:10.1093/pan/mpr025&gt;) that allows users to reweight a dataset such that the covariate distributions in the reweighted data satisfy a set of user specified moment conditions. This can be useful to create balanced samples in observational studies with a binary treatment where the control group data can be reweighted to match the covariate moments in the treatment group. Entropy balancing can also be used to reweight an experimental dataset to match moments of a target population, or to reweight a survey sample to known characteristics from a target population.">
<title>Entropy Reweighting to Create Balanced Samples â€¢ ebal</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="deps/Roboto-0.4.5/font.css" rel="stylesheet">
<link href="deps/JetBrains_Mono-0.4.5/font.css" rel="stylesheet">
<link href="deps/Roboto_Slab-0.4.5/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Entropy Reweighting to Create Balanced Samples">
<meta property="og:description" content="Package implements entropy balancing, a data preprocessing procedure described in Hainmueller (2012, &lt;doi:10.1093/pan/mpr025&gt;) that allows users to reweight a dataset such that the covariate distributions in the reweighted data satisfy a set of user specified moment conditions. This can be useful to create balanced samples in observational studies with a binary treatment where the control group data can be reweighted to match the covariate moments in the treatment group. Entropy balancing can also be used to reweight an experimental dataset to match moments of a target population, or to reweight a survey sample to known characteristics from a target population.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">ebal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/performance_comparisons.html">Entropy Balancing Performance Considerations</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="ebal--entropy-balancing">
<code>ebal</code> : Entropy Balancing<a class="anchor" aria-label="anchor" href="#ebal--entropy-balancing"></a>
</h1></div>
<p>Updated version of the <code>ebal</code> R package for the entropy balancing method to compute method-of-moments based inverse propensity scores for causal inference and related problems.</p>
<p>Primary function is <code>ebalance(W, X)</code> to estimate the ATT (where <code>W</code> is the treatment vector).</p>
<p><strong>New features</strong>: The main user-facing function <code>ebalance</code> optionally computes weights using automatic differentiation (via <code>torch</code>) when called with <code>method="AutoDiff"</code>. This greatly improves stability (at the cost of marginally slower runtime) for small problems and greatly improves speed and stability for large problems. For detailed performance comparisons, see <a href="https://nbviewer.org/github/apoorvalal/ebal/blob/master/vignettes/performance_comparisons.pdf" class="external-link">here</a>.</p>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ebal</span><span class="op">)</span></span>
<span><span class="co"># lalonde observational data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://github.com/apoorvalal/LalRUtils/raw/master/data/lalonde.psid.RData"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">yn</span> <span class="op">=</span> <span class="st">"re78"</span>; <span class="va">wn</span> <span class="op">=</span> <span class="st">"treat"</span>; <span class="va">xn</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">lalonde.psid</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">yn</span>, <span class="va">wn</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">################################################################################</span></span>
<span><span class="co"># naive estimate - this is badly biased relative to experimental benchmark of 1794</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">lalonde.psid</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">re78</span><span class="op">[</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">re78</span><span class="op">[</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># -15204.7755</span></span></code></pre></div>
<p><code>ebalance</code> takes a treatment vector and covariates and returns a weight vector for control units.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># solving for weights</span></span>
<span><span class="va">bal_wts</span> <span class="op">=</span> <span class="fu"><a href="reference/ebalance.html">ebalance</a></span><span class="op">(</span><span class="va">lalonde.psid</span><span class="op">[[</span><span class="st">'treat'</span><span class="op">]</span><span class="op">]</span>, <span class="va">lalonde.psid</span><span class="op">[</span>,<span class="va">xn</span><span class="op">]</span>, method <span class="op">=</span> <span class="st">"AutoDiff"</span><span class="op">)</span><span class="op">$</span><span class="va">w</span></span></code></pre></div>
<p>which can then be fed into <code>weighted.mean</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co"># balancing estimate - better</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">lalonde.psid</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">re78</span><span class="op">[</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">re78</span><span class="op">[</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>, <span class="va">bal_wts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># 2422.7965</span></span></code></pre></div>
<p>or into a regression.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">################################################################################</span></span>
<span><span class="co"># augmented balancing estimate</span></span>
<span></span>
<span><span class="co"># create weights vector in dataset for regression - uniform weights for treated units</span></span>
<span><span class="va">lalonde.psid</span><span class="op">[[</span><span class="st">'wt'</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">lalonde.psid</span><span class="op">$</span><span class="va">treat</span><span class="op">)</span>            <span class="co"># treat weights = 1/Nt</span></span>
<span><span class="va">lalonde.psid</span><span class="op">[[</span><span class="st">'wt'</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">lalonde.psid</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="va">bal_wts</span>     <span class="co"># ctrl weights = ebal weights</span></span>
<span></span>
<span><span class="fu">estimatr</span><span class="fu">::</span><span class="fu"><a href="https://declaredesign.org/r/estimatr/reference/lm_robust.html" class="external-link">lm_robust</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">.</span> <span class="op">-</span> <span class="va">wt</span>, weights <span class="op">=</span> <span class="va">wt</span>, <span class="va">lalonde.psid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="va">summary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">coefficients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">.</span><span class="op">[</span><span class="st">'treat'</span>,<span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate Std. Error    t value   Pr(&gt;|t|)   CI Lower   CI Upper         DF</span></span>
<span><span class="co">#  2422.79     750.36       3.23       0.00     953.00    3895.71    2663.00</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="installation">installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<pre><code><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"apoorvalal/ebal"</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="lower-level-functions-for-usage-with-aggregate-data-and-other-reweighting-problems">lower-level functions for usage with aggregate data, and other reweighting problems<a class="anchor" aria-label="anchor" href="#lower-level-functions-for-usage-with-aggregate-data-and-other-reweighting-problems"></a>
</h2>
<p>Reweighting may be useful in a wide variety of settings (e.g.Â survey reweighting, experiment generalization, density ratio estimation). In many cases, you may only have summary statistics and not individual level covariates for the target sample.</p>
<p>In such cases, you may use <code>eb</code> or <code>ebal_torch</code> functions directly, where you supply a donor matrix <code>X0</code>, a target moment vector <code>X1</code>, and optionally supply base weights.</p>
<p>For example, if we only had control group averages in the above problem, we could solve for weights like so:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># target summary - this could come from a census</span></span>
<span><span class="va">X1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">lalonde.psid</span><span class="op">[</span><span class="va">lalonde.psid</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">xn</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># source matrix</span></span>
<span><span class="va">X0</span> <span class="op">=</span> <span class="va">lalonde.psid</span><span class="op">[</span><span class="va">lalonde.psid</span><span class="op">$</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">xn</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># weights that set weighted mean of X0 to X1</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="reference/ebal_torch.html">ebal_torch</a></span><span class="op">(</span><span class="va">X0</span>, <span class="va">X1</span><span class="op">)</span><span class="op">$</span><span class="va">Weights.ebal</span></span>
<span></span>
<span><span class="co"># same as above</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">lalonde.psid</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">re78</span><span class="op">[</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="va">re78</span><span class="op">[</span><span class="va">treat</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>, <span class="va">w</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># 2422.7965</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=ebal" class="external-link">View on CRAN</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>GPL (&gt;= 2)</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing ebal</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jens Hainmueller <br><small class="roles"> Author, maintainer </small>  </li>
<li>Apoorva Lal <br><small class="roles"> Author </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jens Hainmueller, Apoorva Lal.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
